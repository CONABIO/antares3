

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Land cover and land cover change: API example &mdash; antares3 0.4.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Sentinel 2 based Land cover example" href="example_s2_land_cover.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> antares3
          

          
          </a>

          
            
            
              <div class="version">
                0.4.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="download.html">Downloading data</a></li>
<li class="toctree-l1"><a class="reference internal" href="ingest.html">Ingesting data</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="extend.html">Extending the system</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="example_s2_land_cover.html">Sentinel 2 based Land cover example</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Land cover and land cover change: API example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#madmex-antares-antares-madmex">madmex - antares / antares - madmex ???</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inventory">Inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#summary-of-steps">Summary of steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#loading-the-libraries">Loading the libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-data-over-a-small-study-area">Load data over a small study area</a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-modeling-features">Compute modeling features</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-the-training-data">Load the training data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#train-a-model">Train a model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#extract-training-features">Extract training features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#training-the-model">Training the model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#run-a-spatial-segmentation">Run a spatial segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#predict-land-cover">Predict land cover</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#extract-prediction-features">Extract prediction features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-trained-model-in-prediction-mode">Run trained model in prediction mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#combined-predicted-labels-with-segmentation-geometries">Combined predicted labels with segmentation geometries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#change-detection-and-labeling">Change detection and labeling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#detect-spectral-change">Detect spectral change</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clean-and-label-changes">Clean and label changes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#first-filter-minimum-mapping-unit">First filter: minimum mapping unit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#assign-pre-and-post-labels-to-change-layer">Assign pre and post labels to change layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#second-filter-no-change-in-label">Second filter: No change in label</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#write-output-to-a-vector-file">Write output to a vector file</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualization-and-observations">Visualization and observations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#land-cover">Land cover</a></li>
<li class="toctree-l3"><a class="reference internal" href="#land-cover-change">Land cover change</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">antares3</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Land cover and land cover change: API example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/example_api.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="land-cover-and-land-cover-change-api-example">
<h1>Land cover and land cover change: API example<a class="headerlink" href="#land-cover-and-land-cover-change-api-example" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The example below walks you through the process of generating land cover and land cover change information, taking as example a small region of the state of Jalisco, Mexico. The steps described do not make use of the command line functionalities of antares, but instead use the API directly. While we do not recommend direct use of the API for map production over large areas, it is essential for developers, maintainers and people who want to extent the antares system to understand the antares mechanisms and philosophy. This example aims at building this kind of understanding.</p>
<p>Fully understanding the tutorial requires knowledge of some key python geospatial concepts and data structures. They are briefly reminded below:</p>
<ul class="simple">
<li>Feature collection: a valid feature collection in python is a list of geojson features. Features are dictionaries that each contain at least a geometry and a dictionary of properties. <a class="reference external" href="http://geojson.org/">The geojson specifications</a> defines the structure of valid geojson features. Sometimes, lists of <code class="docutils literal notranslate"><span class="pre">(geometry,</span> <span class="pre">value)</span></code> tuples are referred to as features collections. This is an abuse as they are not list of valid geojson features, however, this way of organizing data is often used in the internals of antares since it maps to database inserts and queries.</li>
<li><code class="docutils literal notranslate"><span class="pre">xarray</span></code> <code class="docutils literal notranslate"><span class="pre">DataArray</span></code> s, <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> s and <code class="docutils literal notranslate"><span class="pre">geoarrays</span></code>: The <code class="docutils literal notranslate"><span class="pre">xarray</span></code> python package introduces two data structures; the <code class="docutils literal notranslate"><span class="pre">DataArray</span></code> and the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>. Excellent documentation can be found <a class="reference external" href="http://xarray.pydata.org/en/stable/">here</a> to understand <code class="docutils literal notranslate"><span class="pre">xarray</span></code>’s paradigm and how to work with these data structures. In the example we sometimes refer to <code class="docutils literal notranslate"><span class="pre">geoarrays</span></code>. They are <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> with a few additional attributes (namely <code class="docutils literal notranslate"><span class="pre">crs</span></code>, <code class="docutils literal notranslate"><span class="pre">geobox</span></code>, <code class="docutils literal notranslate"><span class="pre">affine</span></code>, etc) and are usually returned by calls to datacube.</li>
<li>Basic python data structures and operations: lists, tuples, dictionaries and list comprehensions. Here list comprehensions is the preferred way to manipulate features collections (e.g.: change structure of features, reproject, filter on attributes, etc).</li>
</ul>
</div>
<div class="section" id="madmex-antares-antares-madmex">
<h2>madmex - antares / antares - madmex ???<a class="headerlink" href="#madmex-antares-antares-madmex" title="Permalink to this headline">¶</a></h2>
<p>In the text below reference is made to both madmex and antares. Truth be told we like both names which makes it hard to decide how to name things. We inheritted the madmex name from previous systems built at CONABIO and keep calling things that way, but we also like antares. As it stands now, antares is the name of the system and madmex the name of the python package that makes the system.</p>
</div>
<div class="section" id="inventory">
<h2>Inventory<a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h2>
<p>The starting point for the steps described below is the following:</p>
<ul class="simple">
<li>A system with antares and datacube successfully installed</li>
<li>Landsat 8 data ingested in the datacube under the product name <code class="docutils literal notranslate"><span class="pre">ls8_espa_mexico</span></code> (we ingested year 2014 and 2017 over a small region of interest near guadalajara, state of Jalisco, Mexico).</li>
<li>CGIAR void filled 90m SRTM DEM ingested under the name <code class="docutils literal notranslate"><span class="pre">srtm_cgiar_mexico</span></code></li>
<li>Training data ingested in the antares database using the <code class="docutils literal notranslate"><span class="pre">antares</span> <span class="pre">ingest_training</span></code> command line and registered under the name <code class="docutils literal notranslate"><span class="pre">jalisco_bits</span></code></li>
</ul>
</div>
<div class="section" id="summary-of-steps">
<h2>Summary of steps<a class="headerlink" href="#summary-of-steps" title="Permalink to this headline">¶</a></h2>
<p>We’ll produce two land cover maps for the year 2014 and 2017, and a land cover change map. The following steps are required:</p>
<ul class="simple">
<li>Load raw data for both years</li>
<li>Compute modeling features (vegetation indices and temporal statistics) for both years</li>
<li>Load the training data that intersect with the region of interest</li>
<li>Overlay training data with modeling features to extract training arrays</li>
<li>Train a model</li>
<li>Run spatial segmentation and retrieve geometries</li>
<li>Overlay geometries from the segmentation with modeling features to extract prediction arrays</li>
<li>Predict land cover for each geometry of the segmentation</li>
<li>Detect spectral changes between the years</li>
<li>Filter and classify the changes</li>
</ul>
</div>
<div class="section" id="loading-the-libraries">
<h2>Loading the libraries<a class="headerlink" href="#loading-the-libraries" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python standard library</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="c1"># External libraries</span>
<span class="kn">from</span> <span class="nn">datacube</span> <span class="kn">import</span> <span class="n">Datacube</span>
<span class="kn">from</span> <span class="nn">datacube.storage</span> <span class="kn">import</span> <span class="n">masking</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="kn">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">fiona</span>

<span class="c1"># MAdmex imports</span>
<span class="kn">from</span> <span class="nn">madmex.util.xarray</span> <span class="kn">import</span> <span class="n">to_float</span><span class="p">,</span> <span class="n">to_int</span>
<span class="kn">from</span> <span class="nn">madmex.segmentation.bis</span> <span class="kn">import</span> <span class="n">Segmentation</span>
<span class="kn">from</span> <span class="nn">madmex.overlay.extractions</span> <span class="kn">import</span> <span class="n">zonal_stats_xarray</span>
<span class="kn">from</span> <span class="nn">madmex.io.vector_db</span> <span class="kn">import</span> <span class="n">VectorDb</span>
<span class="kn">from</span> <span class="nn">madmex.modeling.supervised.lgb</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">madmex.lcc.bitemporal.distance</span> <span class="kn">import</span> <span class="n">BiChange</span>
</pre></div>
</div>
</div>
<div class="section" id="load-data-over-a-small-study-area">
<h2>Load data over a small study area<a class="headerlink" href="#load-data-over-a-small-study-area" title="Permalink to this headline">¶</a></h2>
<p>This is a small study area (approximately 40 x 40 km) near the city of Guadalajara.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span> <span class="o">=</span> <span class="n">Datacube</span><span class="p">(</span><span class="n">app</span> <span class="o">=</span> <span class="s1">&#39;jalisco_lcc&#39;</span><span class="p">)</span>
<span class="n">sp_query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="s1">&#39;ls8_espa_mexico&#39;</span><span class="p">,</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">104</span><span class="p">,</span> <span class="o">-</span><span class="mf">103.6</span><span class="p">),</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">20.4</span><span class="p">)}</span>
<span class="n">geoarray_pre</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">**</span><span class="n">sp_query</span><span class="p">,</span>
                       <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;2014-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2014-12-31&#39;</span><span class="p">),</span>
                       <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;solar_day&#39;</span><span class="p">)</span>
<span class="n">geoarray_post</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">**</span><span class="n">sp_query</span><span class="p">,</span>
                       <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;2017-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2017-12-31&#39;</span><span class="p">),</span>
                       <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;solar_day&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">geoarray_pre</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">&gt;</span>
<span class="n">Dimensions</span><span class="p">:</span>   <span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1407</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">1497</span><span class="p">)</span>
<span class="n">Coordinates</span><span class="p">:</span>
  <span class="o">*</span> <span class="n">time</span>      <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="n">datetime64</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="n">T17</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">17.728594</span> <span class="o">...</span>
  <span class="o">*</span> <span class="n">y</span>         <span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="n">float64</span> <span class="mf">9.398e+05</span> <span class="mf">9.398e+05</span> <span class="mf">9.397e+05</span> <span class="mf">9.397e+05</span> <span class="mf">9.397e+05</span> <span class="o">...</span>
  <span class="o">*</span> <span class="n">x</span>         <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">float64</span> <span class="mf">2.292e+06</span> <span class="mf">2.292e+06</span> <span class="mf">2.292e+06</span> <span class="mf">2.292e+06</span> <span class="mf">2.292e+06</span> <span class="o">...</span>
<span class="n">Data</span> <span class="n">variables</span><span class="p">:</span>
    <span class="n">blue</span>      <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">567</span> <span class="mi">605</span> <span class="mi">518</span> <span class="mi">492</span> <span class="mi">513</span> <span class="mi">396</span> <span class="mi">424</span> <span class="mi">434</span> <span class="mi">417</span> <span class="mi">420</span> <span class="mi">414</span> <span class="o">...</span>
    <span class="n">green</span>     <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">793</span> <span class="mi">851</span> <span class="mi">742</span> <span class="mi">706</span> <span class="mi">713</span> <span class="mi">574</span> <span class="mi">572</span> <span class="mi">566</span> <span class="mi">554</span> <span class="mi">554</span> <span class="mi">543</span> <span class="o">...</span>
    <span class="n">red</span>       <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">935</span> <span class="mi">1039</span> <span class="mi">858</span> <span class="mi">792</span> <span class="mi">818</span> <span class="mi">590</span> <span class="mi">608</span> <span class="mi">606</span> <span class="mi">587</span> <span class="mi">584</span> <span class="o">...</span>
    <span class="n">nir</span>       <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">2227</span> <span class="mi">2353</span> <span class="mi">2278</span> <span class="mi">2350</span> <span class="mi">2471</span> <span class="mi">2255</span> <span class="mi">2000</span> <span class="mi">1861</span> <span class="o">...</span>
    <span class="n">swir1</span>     <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">2936</span> <span class="mi">3007</span> <span class="mi">2687</span> <span class="mi">2766</span> <span class="mi">2582</span> <span class="mi">2184</span> <span class="mi">2212</span> <span class="mi">2239</span> <span class="o">...</span>
    <span class="n">swir2</span>     <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">2093</span> <span class="mi">2119</span> <span class="mi">1841</span> <span class="mi">1818</span> <span class="mi">1692</span> <span class="mi">1432</span> <span class="mi">1464</span> <span class="mi">1523</span> <span class="o">...</span>
    <span class="n">pixel_qa</span>  <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="mi">322</span> <span class="o">...</span>
<span class="n">Attributes</span><span class="p">:</span>
    <span class="n">crs</span><span class="p">:</span>      <span class="n">PROJCS</span><span class="p">[</span><span class="s2">&quot;unnamed&quot;</span><span class="p">,</span><span class="n">GEOGCS</span><span class="p">[</span><span class="s2">&quot;WGS 84&quot;</span><span class="p">,</span><span class="n">DATUM</span><span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span><span class="n">SPHEROID</span><span class="p">[</span><span class="s2">&quot;WGS8...</span>
</pre></div>
</div>
</div>
<div class="section" id="compute-modeling-features">
<h2>Compute modeling features<a class="headerlink" href="#compute-modeling-features" title="Permalink to this headline">¶</a></h2>
<p>We chose here to construct modeling features by applying temporal reduction to the Landsat spectral bands as well as vegetation indices. These temporally reduced features are combined with terrain metrics, resulting in 15 features.
The complete set or subsets of these features will be used in various steps of the process.</p>
<p>We define a function that performs the temporal reduction and combine the resulting features with terrain metrics. The function returns a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>. Note that this reduction process is entirely pixel based, so that the spatial characteristics of both geoarrays remain unchanged.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is what <code class="docutils literal notranslate"><span class="pre">antares</span> <span class="pre">apply_recipe</span></code> does when the system is operated from the command line, the <code class="docutils literal notranslate"><span class="pre">landsat_prepare_features</span></code> function was actually taken from one of the existing recipes.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">landsat_prepare_features</span><span class="p">(</span><span class="n">sr</span><span class="p">):</span>
    <span class="n">clear</span> <span class="o">=</span> <span class="n">masking</span><span class="o">.</span><span class="n">make_mask</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">pixel_qa</span><span class="p">,</span> <span class="n">cloud</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cloud_shadow</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                  <span class="n">snow</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">sr_1</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span>
    <span class="n">sr_1</span> <span class="o">=</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;pixel_qa&#39;</span><span class="p">)</span>
    <span class="n">sr_1</span> <span class="o">=</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">to_float</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># Compute vegetation indices</span>
    <span class="n">sr_1</span><span class="p">[</span><span class="s1">&#39;ndvi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">sr_1</span><span class="o">.</span><span class="n">nir</span> <span class="o">-</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">red</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sr_1</span><span class="o">.</span><span class="n">nir</span> <span class="o">+</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">red</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10000</span>
    <span class="n">sr_1</span><span class="p">[</span><span class="s1">&#39;ndvi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    <span class="n">sr_1</span><span class="p">[</span><span class="s1">&#39;ndmi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">sr_1</span><span class="o">.</span><span class="n">nir</span> <span class="o">-</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">swir1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sr_1</span><span class="o">.</span><span class="n">nir</span> <span class="o">+</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">swir1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10000</span>
    <span class="n">sr_1</span><span class="p">[</span><span class="s1">&#39;ndmi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    <span class="c1"># Run temporal reductions and rename DataArrays</span>
    <span class="n">sr_mean</span> <span class="o">=</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">sr_mean</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="s1">&#39;blue_mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;green&#39;</span><span class="p">:</span> <span class="s1">&#39;green_mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="s1">&#39;red_mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nir&#39;</span><span class="p">:</span> <span class="s1">&#39;nir_mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;swir1&#39;</span><span class="p">:</span> <span class="s1">&#39;swir1_mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;swir2&#39;</span><span class="p">:</span> <span class="s1">&#39;swir2_mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ndmi&#39;</span><span class="p">:</span> <span class="s1">&#39;ndmi_mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ndvi&#39;</span><span class="p">:</span> <span class="s1">&#39;ndvi_mean&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># Compute min/max/std only for vegetation indices</span>
    <span class="n">ndvi_max</span> <span class="o">=</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">ndvi</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ndvi_max</span> <span class="o">=</span> <span class="n">ndvi_max</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;ndvi_max&#39;</span><span class="p">)</span>
    <span class="n">ndvi_max</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    <span class="n">ndvi_min</span> <span class="o">=</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">ndvi</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ndvi_min</span> <span class="o">=</span> <span class="n">ndvi_min</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;ndvi_min&#39;</span><span class="p">)</span>
    <span class="n">ndvi_min</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    <span class="c1"># ndmi</span>
    <span class="n">ndmi_max</span> <span class="o">=</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">ndmi</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ndmi_max</span> <span class="o">=</span> <span class="n">ndmi_max</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;ndmi_max&#39;</span><span class="p">)</span>
    <span class="n">ndmi_max</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    <span class="n">ndmi_min</span> <span class="o">=</span> <span class="n">sr_1</span><span class="o">.</span><span class="n">ndmi</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ndmi_min</span> <span class="o">=</span> <span class="n">ndmi_min</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;ndmi_min&#39;</span><span class="p">)</span>
    <span class="n">ndmi_min</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    <span class="c1"># Load terrain metrics using same spatial parameters than sr</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="n">Datacube</span><span class="p">(</span><span class="n">app</span> <span class="o">=</span> <span class="s1">&#39;feature_creation&#39;</span><span class="p">)</span>
    <span class="n">terrain</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;srtm_cgiar_mexico&#39;</span><span class="p">,</span> <span class="n">like</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                      <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">dc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Merge dataarrays</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">sr_mean</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_int</span><span class="p">),</span>
                         <span class="n">to_int</span><span class="p">(</span><span class="n">ndvi_max</span><span class="p">),</span>
                         <span class="n">to_int</span><span class="p">(</span><span class="n">ndvi_min</span><span class="p">),</span>
                         <span class="n">to_int</span><span class="p">(</span><span class="n">ndmi_max</span><span class="p">),</span>
                         <span class="n">to_int</span><span class="p">(</span><span class="n">ndmi_min</span><span class="p">),</span>
                         <span class="n">terrain</span><span class="p">])</span>
    <span class="n">combined</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">combined</span>
</pre></div>
</div>
<p>The function can then be applied to both input arrays (2014 and 2017).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">features_pre</span> <span class="o">=</span> <span class="n">ls8_pp</span><span class="p">(</span><span class="n">geoarray_pre</span><span class="p">)</span>
<span class="n">features_post</span> <span class="o">=</span> <span class="n">ls8_pp</span><span class="p">(</span><span class="n">geoarray_post</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">features_pre</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">&gt;</span>
<span class="n">Dimensions</span><span class="p">:</span>     <span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1407</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">1497</span><span class="p">)</span>
<span class="n">Coordinates</span><span class="p">:</span>
  <span class="o">*</span> <span class="n">y</span>           <span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="n">float64</span> <span class="mf">9.398e+05</span> <span class="mf">9.398e+05</span> <span class="mf">9.397e+05</span> <span class="mf">9.397e+05</span> <span class="o">...</span>
  <span class="o">*</span> <span class="n">x</span>           <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">float64</span> <span class="mf">2.292e+06</span> <span class="mf">2.292e+06</span> <span class="mf">2.292e+06</span> <span class="mf">2.292e+06</span> <span class="o">...</span>
  <span class="o">*</span> <span class="n">time</span>        <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="n">datetime64</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span><span class="n">T12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">Data</span> <span class="n">variables</span><span class="p">:</span>
    <span class="n">blue_mean</span>   <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">663</span> <span class="mi">695</span> <span class="mi">605</span> <span class="mi">643</span> <span class="mi">624</span> <span class="mi">448</span> <span class="mi">476</span> <span class="mi">486</span> <span class="mi">469</span> <span class="mi">480</span> <span class="mi">477</span> <span class="mi">491</span> <span class="o">...</span>
    <span class="n">green_mean</span>  <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">977</span> <span class="mi">1033</span> <span class="mi">883</span> <span class="mi">950</span> <span class="mi">940</span> <span class="mi">644</span> <span class="mi">642</span> <span class="mi">645</span> <span class="mi">624</span> <span class="mi">635</span> <span class="mi">626</span> <span class="o">...</span>
    <span class="n">red_mean</span>    <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">1240</span> <span class="mi">1335</span> <span class="mi">1124</span> <span class="mi">1201</span> <span class="mi">1180</span> <span class="mi">764</span> <span class="mi">763</span> <span class="mi">761</span> <span class="mi">736</span> <span class="mi">750</span> <span class="o">...</span>
    <span class="n">nir_mean</span>    <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">2560</span> <span class="mi">2708</span> <span class="mi">2495</span> <span class="mi">2714</span> <span class="mi">2758</span> <span class="mi">2149</span> <span class="mi">1995</span> <span class="mi">1902</span> <span class="mi">1803</span> <span class="o">...</span>
    <span class="n">swir1_mean</span>  <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">3183</span> <span class="mi">3282</span> <span class="mi">2994</span> <span class="mi">3151</span> <span class="mi">3109</span> <span class="mi">2442</span> <span class="mi">2416</span> <span class="mi">2442</span> <span class="mi">2478</span> <span class="o">...</span>
    <span class="n">swir2_mean</span>  <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">2216</span> <span class="mi">2251</span> <span class="mi">1990</span> <span class="mi">2068</span> <span class="mi">2043</span> <span class="mi">1632</span> <span class="mi">1643</span> <span class="mi">1681</span> <span class="mi">1720</span> <span class="o">...</span>
    <span class="n">ndvi_mean</span>   <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">3539</span> <span class="mi">3451</span> <span class="mi">3857</span> <span class="mi">4012</span> <span class="mi">4146</span> <span class="mi">4776</span> <span class="mi">4502</span> <span class="mi">4330</span> <span class="mi">4248</span> <span class="o">...</span>
    <span class="n">ndmi_mean</span>   <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="o">-</span><span class="mi">1092</span> <span class="o">-</span><span class="mi">964</span> <span class="o">-</span><span class="mi">901</span> <span class="o">-</span><span class="mi">738</span> <span class="o">-</span><span class="mi">554</span> <span class="o">-</span><span class="mi">617</span> <span class="o">-</span><span class="mi">937</span> <span class="o">-</span><span class="mi">1223</span> <span class="o">-</span><span class="mi">1556</span> <span class="o">...</span>
    <span class="n">ndvi_max</span>    <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">4113</span> <span class="mi">3977</span> <span class="mi">4534</span> <span class="mi">4958</span> <span class="mi">5076</span> <span class="mi">5852</span> <span class="mi">5468</span> <span class="mi">5242</span> <span class="mi">5126</span> <span class="o">...</span>
    <span class="n">ndvi_min</span>    <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">2861</span> <span class="mi">2861</span> <span class="mi">3030</span> <span class="mi">2993</span> <span class="mi">3050</span> <span class="mi">3480</span> <span class="mi">3421</span> <span class="mi">3326</span> <span class="mi">3226</span> <span class="o">...</span>
    <span class="n">ndmi_max</span>    <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="o">-</span><span class="mi">949</span> <span class="o">-</span><span class="mi">820</span> <span class="o">-</span><span class="mi">749</span> <span class="o">-</span><span class="mi">536</span> <span class="o">-</span><span class="mi">151</span> <span class="mi">159</span> <span class="o">-</span><span class="mi">345</span> <span class="o">-</span><span class="mi">662</span> <span class="o">-</span><span class="mi">1033</span> <span class="o">...</span>
    <span class="n">ndmi_min</span>    <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="o">-</span><span class="mi">1373</span> <span class="o">-</span><span class="mi">1220</span> <span class="o">-</span><span class="mi">1115</span> <span class="o">-</span><span class="mi">834</span> <span class="o">-</span><span class="mi">1033</span> <span class="o">-</span><span class="mi">1460</span> <span class="o">-</span><span class="mi">1556</span> <span class="o">-</span><span class="mi">1678</span> <span class="o">...</span>
    <span class="n">elevation</span>   <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">int16</span> <span class="mi">1745</span> <span class="mi">1745</span> <span class="mi">1745</span> <span class="mi">1731</span> <span class="mi">1731</span> <span class="mi">1731</span> <span class="mi">1710</span> <span class="mi">1710</span> <span class="o">...</span>
    <span class="n">slope</span>       <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">float32</span> <span class="mf">18.342178</span> <span class="mf">18.342178</span> <span class="mf">18.342178</span> <span class="mf">20.278563</span> <span class="o">...</span>
    <span class="n">aspect</span>      <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="n">float32</span> <span class="mf">163.92642</span> <span class="mf">163.92642</span> <span class="mf">163.92642</span> <span class="mf">148.74905</span> <span class="o">...</span>
<span class="n">Attributes</span><span class="p">:</span>
    <span class="n">crs</span><span class="p">:</span>      <span class="n">PROJCS</span><span class="p">[</span><span class="s2">&quot;unnamed&quot;</span><span class="p">,</span><span class="n">GEOGCS</span><span class="p">[</span><span class="s2">&quot;WGS 84&quot;</span><span class="p">,</span><span class="n">DATUM</span><span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span><span class="n">SPHEROID</span><span class="p">[</span><span class="s2">&quot;WGS8...</span>
</pre></div>
</div>
</div>
<div class="section" id="load-the-training-data">
<h2>Load the training data<a class="headerlink" href="#load-the-training-data" title="Permalink to this headline">¶</a></h2>
<p>As mentioned earlier, training data have been ingested in the database. We’ll retrieve a random subset of them. The code below sends a query to the database to identify geometries that spatially intersect with the geoarrays and retrieve them as a feature collection. We’re assuming that these labelled geometries represent true land cover.</p>
<p>Because the training data represents a complete map (spatially continuous), we’ll only load a random subset of it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">VectorDb</span><span class="p">()</span>
<span class="n">fc_train_0</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_training_from_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">features_pre</span><span class="p">,</span>
                                               <span class="n">training_set</span><span class="o">=</span><span class="s1">&#39;jalisco_bits&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="c1"># Evaluate the generator (safe to do here since the data is relatively small)</span>
<span class="n">fc_train_0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fc_train_0</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">fc_train_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="p">[[[</span><span class="mf">2326252.027988377</span><span class="p">,</span> <span class="mf">910734.3428333736</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326261.9863412823</span><span class="p">,</span> <span class="mf">910734.1467824185</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326261.8882086305</span><span class="p">,</span> <span class="mf">910729.1380236337</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326266.867385206</span><span class="p">,</span> <span class="mf">910729.0399985655</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326266.6711206264</span><span class="p">,</span> <span class="mf">910719.0224803672</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326271.6502976064</span><span class="p">,</span> <span class="mf">910718.9244556869</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326271.552165666</span><span class="p">,</span> <span class="mf">910713.9156962705</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326281.5105198696</span><span class="p">,</span> <span class="mf">910713.7196477344</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326281.6086513186</span><span class="p">,</span> <span class="mf">910718.7284069781</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326231.620611946</span><span class="p">,</span> <span class="mf">910709.6911390346</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326231.52247825</span><span class="p">,</span> <span class="mf">910704.6823784625</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326236.5016564964</span><span class="p">,</span> <span class="mf">910704.5843524567</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326236.4035231196</span><span class="p">,</span> <span class="mf">910699.5755917204</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326246.3618798703</span><span class="p">,</span> <span class="mf">910699.3795405444</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326246.4600127693</span><span class="p">,</span> <span class="mf">910704.3883011278</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326251.439190782</span><span class="p">,</span> <span class="mf">910704.2902757933</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326251.635456333</span><span class="p">,</span> <span class="mf">910714.3077960224</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326246.656278798</span><span class="p">,</span> <span class="mf">910714.4058215156</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326246.950678438</span><span class="p">,</span> <span class="mf">910729.4321001584</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326251.929855247</span><span class="p">,</span> <span class="mf">910729.3340744303</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326252.027988377</span><span class="p">,</span> <span class="mf">910734.3428333736</span><span class="p">]]],</span>
              <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">},</span>
 <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="mi">153</span><span class="p">},</span>
 <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>The property here refers to a unique database id for the class. Although convenient for interacting with the database, this is not very meaningful in the present case. Because we know much better the numeric codes of the madmex classification scheme, we will convert these database indices to the known madmex classes numeric codes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">madmex.models</span> <span class="kn">import</span> <span class="n">Tag</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;madmex&#39;</span><span class="p">)</span>
<span class="n">tag_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">numeric_code</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">}</span>
<span class="n">tag_id_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fc_train_0</span><span class="p">]</span>
<span class="n">fc_train</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
             <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">tag_mapping</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]},</span>
             <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;feature&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fc_train_0</span><span class="p">,</span> <span class="n">tag_id_list</span><span class="p">)]</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">fc_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>The same feature now appears with the numeric code <code class="docutils literal notranslate"><span class="pre">2</span></code> instead of the tag-id <code class="docutils literal notranslate"><span class="pre">153</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="p">[[[</span><span class="mf">2326252.027988377</span><span class="p">,</span> <span class="mf">910734.3428333736</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326261.9863412823</span><span class="p">,</span> <span class="mf">910734.1467824185</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326261.8882086305</span><span class="p">,</span> <span class="mf">910729.1380236337</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326266.867385206</span><span class="p">,</span> <span class="mf">910729.0399985655</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326266.6711206264</span><span class="p">,</span> <span class="mf">910719.0224803672</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326271.6502976064</span><span class="p">,</span> <span class="mf">910718.9244556869</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326271.552165666</span><span class="p">,</span> <span class="mf">910713.9156962705</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326281.5105198696</span><span class="p">,</span> <span class="mf">910713.7196477344</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326281.6086513186</span><span class="p">,</span> <span class="mf">910718.7284069781</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326231.620611946</span><span class="p">,</span> <span class="mf">910709.6911390346</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326231.52247825</span><span class="p">,</span> <span class="mf">910704.6823784625</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326236.5016564964</span><span class="p">,</span> <span class="mf">910704.5843524567</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326236.4035231196</span><span class="p">,</span> <span class="mf">910699.5755917204</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326246.3618798703</span><span class="p">,</span> <span class="mf">910699.3795405444</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326246.4600127693</span><span class="p">,</span> <span class="mf">910704.3883011278</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326251.439190782</span><span class="p">,</span> <span class="mf">910704.2902757933</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326251.635456333</span><span class="p">,</span> <span class="mf">910714.3077960224</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326246.656278798</span><span class="p">,</span> <span class="mf">910714.4058215156</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326246.950678438</span><span class="p">,</span> <span class="mf">910729.4321001584</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326251.929855247</span><span class="p">,</span> <span class="mf">910729.3340744303</span><span class="p">],</span>
                               <span class="p">[</span><span class="mf">2326252.027988377</span><span class="p">,</span> <span class="mf">910734.3428333736</span><span class="p">]]],</span>
              <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">},</span>
 <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
 <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="train-a-model">
<h2>Train a model<a class="headerlink" href="#train-a-model" title="Permalink to this headline">¶</a></h2>
<p>In the present case, we are not saving the model to the database or doing any other kind of antares specific operations related to modeling, so that we do not really benefit from using the <code class="docutils literal notranslate"><span class="pre">Model</span></code> class from the <code class="docutils literal notranslate"><span class="pre">madmex.modeling.supervized</span></code> submodules. Calling the scikit learn interface of lightGBM would provide the same results, however, for consistency with the rest of the tutorial we will use the madmex modeling interface.</p>
<div class="section" id="extract-training-features">
<h3>Extract training features<a class="headerlink" href="#extract-training-features" title="Permalink to this headline">¶</a></h3>
<p>Similarly to scikit learn, madmex’s modeling interface takes numpy arrays as input and returns numpy arrays too. At the moment we have a feature collection of labelled geometries on one side and an xarray Dataset of features on the other side. We extract the data to labels and predictors arrays (<code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">X</span></code>) using the <code class="docutils literal notranslate"><span class="pre">zonal_stats_xarray()</span></code> function from madmex’s <code class="docutils literal notranslate"><span class="pre">overlay</span></code> module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">zonal_stats_xarray</span><span class="p">(</span><span class="n">features_pre</span><span class="p">,</span> <span class="n">fc_train</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="training-the-model">
<h3>Training the model<a class="headerlink" href="#training-the-model" title="Permalink to this headline">¶</a></h3>
<p>The model can now be trained using scikit learn like syntax.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate Model class of lgb submodule</span>
<span class="n">lgb_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="n">lgb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">How many models should we train? We have the options of either training a single model and use it to predict over both years, or training two separate models for each years. Both approaches are sub-optimal; the trade-off is between accepting that some of the training data may not completely represent reality (in case of land cover change between training data generation and year considered for the modeling features), and accepting that the modeling feature may not be completely stable over time.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The command line <code class="docutils literal notranslate"><span class="pre">antares</span> <span class="pre">model_fit</span></code> combines the steps from loading the training data, up to this point.</p>
</div>
</div>
</div>
<div class="section" id="run-a-spatial-segmentation">
<h2>Run a spatial segmentation<a class="headerlink" href="#run-a-spatial-segmentation" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">segmentation</span></code> module offers an interface to segment georeferenced arrays (<code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> + affine + crs or datacube like <code class="docutils literal notranslate"><span class="pre">xarray.Dataset</span></code> (<code class="docutils literal notranslate"><span class="pre">geoarrays</span></code>)), generate feature collections and interact with the database. Here we use the Berkeley image segmentation algorithm (bis) as seen in the imports section. We limit the number of input bands for the segmentation to two, <code class="docutils literal notranslate"><span class="pre">ndvi_mean</span></code> and <code class="docutils literal notranslate"><span class="pre">ndmi_mean</span></code>, and run the segmentation on both geoarrays (2014 and 2017).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s_bands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ndvi_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndmi_mean&#39;</span><span class="p">]</span>
<span class="n">Segmenter_pre</span> <span class="o">=</span> <span class="n">Segmentation</span><span class="o">.</span><span class="n">from_geoarray</span><span class="p">(</span><span class="n">features_pre</span><span class="p">[</span><span class="n">s_bands</span><span class="p">],</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">Segmenter_post</span> <span class="o">=</span> <span class="n">Segmentation</span><span class="o">.</span><span class="n">from_geoarray</span><span class="p">(</span><span class="n">features_post</span><span class="p">[</span><span class="n">s_bands</span><span class="p">],</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">Segmenter_pre</span><span class="o">.</span><span class="n">segment</span><span class="p">()</span>
<span class="n">Segmenter_post</span><span class="o">.</span><span class="n">segment</span><span class="p">()</span>
</pre></div>
</div>
<p>The first step of the segmentation process generates an array of segmented zones, written to a slot of the class instance. The <code class="docutils literal notranslate"><span class="pre">polygonize()</span></code> method allows to generate a feature collection, written to the <code class="docutils literal notranslate"><span class="pre">fc</span></code> attribute of the instance. We can then access this attribute and inspect it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Segmenter_pre</span><span class="o">.</span><span class="n">polygonize</span><span class="p">(</span><span class="n">crs_out</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">Segmenter_post</span><span class="o">.</span><span class="n">polygonize</span><span class="p">(</span><span class="n">crs_out</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">fc_seg_pre</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Segmenter_pre</span><span class="o">.</span><span class="n">fc</span><span class="p">)</span>
<span class="n">fc_seg_post</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Segmenter_post</span><span class="o">.</span><span class="n">fc</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">fc_seg_pre</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fc_seg_pre</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fc_seg_post</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="p">[[(</span><span class="mf">2291520.0</span><span class="p">,</span> <span class="mf">939800.0</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">2291520.0</span><span class="p">,</span> <span class="mf">939680.0</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">2291550.0</span><span class="p">,</span> <span class="mf">939680.0</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">2291550.0</span><span class="p">,</span> <span class="mf">939650.0</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">2291580.0</span><span class="p">,</span> <span class="mf">939650.0</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">2291580.0</span><span class="p">,</span> <span class="mf">939680.0</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">2291610.0</span><span class="p">,</span> <span class="mf">939680.0</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">2291610.0</span><span class="p">,</span> <span class="mf">939800.0</span><span class="p">),</span>
                               <span class="p">(</span><span class="mf">2291520.0</span><span class="p">,</span> <span class="mf">939800.0</span><span class="p">)]],</span>
              <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">},</span>
 <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mf">46678.0</span><span class="p">},</span>
 <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">}</span>
<span class="mi">243983</span>
<span class="mi">201879</span>
</pre></div>
</div>
<p>We now have for each year a feature collection whose geometries correspond to the spatial segments generated by the segmentation algorithm. The result of <code class="docutils literal notranslate"><span class="pre">len(fc_seg_pre)</span></code> let us appreciate the average object size. In the present case we obtained 243,983 and 201,879 which sounds like an acceptable segmentation for Landsat data, considering the input array contain 2,106,279 pixels (about 10 pixels per object on average).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When operating antares from the command line, segmentation as above is ran via <code class="docutils literal notranslate"><span class="pre">antares</span> <span class="pre">segment</span></code> command.</p>
</div>
</div>
<div class="section" id="predict-land-cover">
<h2>Predict land cover<a class="headerlink" href="#predict-land-cover" title="Permalink to this headline">¶</a></h2>
<p>We now have a trained model, a feature collection of segments and a set of geometric features. For each of the two years, we therefore need to prepare the prepare the array of predictors, predict the label for every observation and combine labels with geometries into a feature collection.</p>
<div class="section" id="extract-prediction-features">
<h3>Extract prediction features<a class="headerlink" href="#extract-prediction-features" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">X_pre</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">zonal_stats_xarray</span><span class="p">(</span><span class="n">features_pre</span><span class="p">,</span> <span class="n">fc_seg_pre</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
<span class="n">X_post</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">zonal_stats_xarray</span><span class="p">(</span><span class="n">features_post</span><span class="p">,</span> <span class="n">fc_seg_post</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="run-trained-model-in-prediction-mode">
<h3>Run trained model in prediction mode<a class="headerlink" href="#run-trained-model-in-prediction-mode" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">y_pre</span> <span class="o">=</span> <span class="n">lgb_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_pre</span><span class="p">)</span>
<span class="n">y_post</span> <span class="o">=</span> <span class="n">lgb_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_post</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="combined-predicted-labels-with-segmentation-geometries">
<h3>Combined predicted labels with segmentation geometries<a class="headerlink" href="#combined-predicted-labels-with-segmentation-geometries" title="Permalink to this headline">¶</a></h3>
<p>Here we’re building a list of <cite>(geometry, value)</cite> tuples.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fc_pred_pre</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fc_seg_pre</span><span class="p">,</span> <span class="n">y_pre</span><span class="p">)]</span>
<span class="n">fc_pred_post</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fc_seg_post</span><span class="p">,</span> <span class="n">y_post</span><span class="p">)]</span>

<span class="n">pprint</span><span class="p">(</span><span class="n">fc_pred_pre</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">({</span><span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="p">[[(</span><span class="mf">2291520.0</span><span class="p">,</span> <span class="mf">939800.0</span><span class="p">),</span>
                   <span class="p">(</span><span class="mf">2291520.0</span><span class="p">,</span> <span class="mf">939680.0</span><span class="p">),</span>
                   <span class="p">(</span><span class="mf">2291550.0</span><span class="p">,</span> <span class="mf">939680.0</span><span class="p">),</span>
                   <span class="p">(</span><span class="mf">2291550.0</span><span class="p">,</span> <span class="mf">939650.0</span><span class="p">),</span>
                   <span class="p">(</span><span class="mf">2291580.0</span><span class="p">,</span> <span class="mf">939650.0</span><span class="p">),</span>
                   <span class="p">(</span><span class="mf">2291580.0</span><span class="p">,</span> <span class="mf">939680.0</span><span class="p">),</span>
                   <span class="p">(</span><span class="mf">2291610.0</span><span class="p">,</span> <span class="mf">939680.0</span><span class="p">),</span>
                   <span class="p">(</span><span class="mf">2291610.0</span><span class="p">,</span> <span class="mf">939800.0</span><span class="p">),</span>
                   <span class="p">(</span><span class="mf">2291520.0</span><span class="p">,</span> <span class="mf">939800.0</span><span class="p">)]],</span>
  <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">},</span>
 <span class="mi">28</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The land cover prediction described above reproduces the steps taken by <code class="docutils literal notranslate"><span class="pre">antares</span> <span class="pre">model_predict_object</span></code> command line.</p>
</div>
</div>
</div>
<div class="section" id="change-detection-and-labeling">
<h2>Change detection and labeling<a class="headerlink" href="#change-detection-and-labeling" title="Permalink to this headline">¶</a></h2>
<div class="section" id="detect-spectral-change">
<h3>Detect spectral change<a class="headerlink" href="#detect-spectral-change" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lcc_pre</span> <span class="o">=</span> <span class="n">BiChange</span><span class="o">.</span><span class="n">from_geoarray</span><span class="p">(</span><span class="n">features_pre</span><span class="p">[</span><span class="n">s_bands</span><span class="p">],</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">lcc_post</span> <span class="o">=</span> <span class="n">BiChange</span><span class="o">.</span><span class="n">from_geoarray</span><span class="p">(</span><span class="n">features_post</span><span class="p">[</span><span class="n">s_bands</span><span class="p">])</span>
<span class="n">lcc_pre</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">lcc_post</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">lcc_pre</span><span class="o">.</span><span class="n">change_array</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">lcc_pre</span><span class="o">.</span><span class="n">change_array</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.0087</span>
</pre></div>
</div>
<p>Given the <code class="docutils literal notranslate"><span class="pre">change_array</span></code> attribute of the <code class="docutils literal notranslate"><span class="pre">BiChange</span></code> class instance is a 2D array of zeros and ones (ones correspond to change and zeros to no change), the array sum tells us the number of pixels labelled as change. In the present case, a bit less than 1 percent of the pixels were labelled as change.</p>
</div>
<div class="section" id="clean-and-label-changes">
<h3>Clean and label changes<a class="headerlink" href="#clean-and-label-changes" title="Permalink to this headline">¶</a></h3>
<p>Three steps:</p>
<ul class="simple">
<li>Minimum mapping unit filter</li>
<li>Pixels labelling using pre and post land cover maps</li>
<li>Filter features having same pre and post land cover label</li>
</ul>
<div class="section" id="first-filter-minimum-mapping-unit">
<h4>First filter: minimum mapping unit<a class="headerlink" href="#first-filter-minimum-mapping-unit" title="Permalink to this headline">¶</a></h4>
<p>It does an update of the <cite>change_array</cite> attribute of the class instance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lcc_pre</span><span class="o">.</span><span class="n">filter_mmu</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">lcc_pre</span><span class="o">.</span><span class="n">change_array</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">lcc_pre</span><span class="o">.</span><span class="n">change_array</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.0077</span>
</pre></div>
</div>
</div>
<div class="section" id="assign-pre-and-post-labels-to-change-layer">
<h4>Assign pre and post labels to change layer<a class="headerlink" href="#assign-pre-and-post-labels-to-change-layer" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fc_change</span> <span class="o">=</span> <span class="n">lcc_pre</span><span class="o">.</span><span class="n">label_change</span><span class="p">(</span><span class="n">fc_pred_pre</span><span class="p">,</span> <span class="n">fc_pred_post</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fc_change</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1813</span>
</pre></div>
</div>
</div>
<div class="section" id="second-filter-no-change-in-label">
<h4>Second filter: No change in label<a class="headerlink" href="#second-filter-no-change-in-label" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fc_change</span> <span class="o">=</span> <span class="n">lcc_pre</span><span class="o">.</span><span class="n">filter_no_change</span><span class="p">(</span><span class="n">fc_change</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fc_change</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1152</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">antares</span> <span class="pre">detect_change</span></code> is the command line equivalent of the bi-temporal change detectiomn and classification steps described above.</p>
</div>
</div>
</div>
</div>
<div class="section" id="write-output-to-a-vector-file">
<h2>Write output to a vector file<a class="headerlink" href="#write-output-to-a-vector-file" title="Permalink to this headline">¶</a></h2>
<p>The change feature collection is a list of tuples <code class="docutils literal notranslate"><span class="pre">(geometry,</span> <span class="pre">pre_label,</span> <span class="pre">post_label)</span></code>, we therefore need to transform it to a geojson compliant feature collection before writing it to a vector file for visualization in an external program (e.g. QGIS).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">from</span> <span class="nn">fiona.crs</span> <span class="kn">import</span> <span class="n">from_string</span>
<span class="kn">from</span> <span class="nn">madmex.util.spatial</span> <span class="kn">import</span> <span class="n">geometry_transform</span>
<span class="n">fc_change_geojson</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">geometry_transform</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crs_in</span><span class="o">=</span><span class="n">lcc_pre</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">crs_out</span><span class="o">=</span><span class="s1">&#39;+proj=longlat&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lc_2014&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;lc_2017&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]},</span>
                      <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;feature&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fc_change</span><span class="p">]</span>
<span class="n">fc_schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">,</span>
             <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lc_2014&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;lc_2017&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">}}</span>
<span class="n">crs</span> <span class="o">=</span> <span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;+proj=longlat&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/home/madmex_user/lc_lcc_api_example.gpkg&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GPKG&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">fc_schema</span><span class="p">,</span>
                <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">writerecords</span><span class="p">(</span><span class="n">fc_change_geojson</span><span class="p">)</span>
</pre></div>
</div>
<p>Opening the vector file in QGIS allows us to visualize detected changes.</p>
<p>We can also write the land cover maps of 2014 and 2017 to visualize them</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fc_schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">,</span>
             <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lc&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">}}</span>

<span class="c1"># Build valid geojson features for both land cover maps</span>
<span class="n">fc_pred_pre_geojson</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">geometry_transform</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crs_in</span><span class="o">=</span><span class="n">lcc_pre</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">crs_out</span><span class="o">=</span><span class="s1">&#39;+proj=longlat&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lc&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])},</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;feature&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fc_pred_pre</span><span class="p">]</span>
<span class="n">fc_pred_post_geojson</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">geometry_transform</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crs_in</span><span class="o">=</span><span class="n">lcc_pre</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">crs_out</span><span class="o">=</span><span class="s1">&#39;+proj=longlat&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lc&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])},</span>
                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;feature&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fc_pred_post</span><span class="p">]</span>

<span class="c1"># Write 2014 map</span>
<span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/home/madmex_user/lc_lcc_api_example.gpkg&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GPKG&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">fc_schema</span><span class="p">,</span>
                <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;lc_2014&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">writerecords</span><span class="p">(</span><span class="n">fc_pred_pre_geojson</span><span class="p">)</span>

<span class="c1"># Write 2017 map</span>
<span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/home/madmex_user/lc_lcc_api_example.gpkg&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GPKG&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">fc_schema</span><span class="p">,</span>
                <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;lc_2017&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">writerecords</span><span class="p">(</span><span class="n">fc_pred_post_geojson</span><span class="p">)</span>
</pre></div>
</div>
<p>Antares can produce a QGIS style to enhance visualization of that particular classification scheme, by running the command line <code class="docutils literal notranslate"><span class="pre">antares</span> <span class="pre">generate_style</span> <span class="pre">madmex</span> <span class="pre">--type</span> <span class="pre">vector</span> <span class="pre">--filename</span> <span class="pre">madmex.qml</span></code>.</p>
</div>
<div class="section" id="visualization-and-observations">
<h2>Visualization and observations<a class="headerlink" href="#visualization-and-observations" title="Permalink to this headline">¶</a></h2>
<p>Using the previously generated file we produced maps of the various products using QGIS.</p>
<div class="section" id="land-cover">
<h3>Land cover<a class="headerlink" href="#land-cover" title="Permalink to this headline">¶</a></h3>
<div class="figure" id="id1">
<a class="reference internal image-reference" href="_images/lc_2014.jpeg"><img alt="Land cover map 2014" src="_images/lc_2014.jpeg" style="width: 708.6px; height: 590.6999999999999px;" /></a>
<p class="caption"><span class="caption-text">Land cover map 2014</span></p>
</div>
<div class="figure" id="id2">
<a class="reference internal image-reference" href="_images/lc_2017.jpeg"><img alt="Land cover map 2017" src="_images/lc_2017.jpeg" style="width: 708.6px; height: 590.6999999999999px;" /></a>
<p class="caption"><span class="caption-text">Land cover map 2017</span></p>
</div>
<p>Despite using the same model for prediction, large differences appear between the two land cover maps. The most striking difference concerns a confusion between the <em>selva baja caducifolia subcaducifolia</em> and <em>tierras agricolas</em> class. Spectral proximity of these two classes is probably high, making the prediction sensible to features instability over time. While the small study area and the lack of quantitative validation figures does not allow for firm conclusion, this certainly questions the choice of reusing the same model for prediction at different time steps without prior normalization of the features.</p>
</div>
<div class="section" id="land-cover-change">
<h3>Land cover change<a class="headerlink" href="#land-cover-change" title="Permalink to this headline">¶</a></h3>
<div class="figure" id="id3">
<a class="reference internal image-reference" href="_images/lcc.gif"><img alt="Land cover change animation" src="_images/lcc.gif" style="width: 354.3px; height: 295.5px;" /></a>
<p class="caption"><span class="caption-text">Land cover change animation</span></p>
</div>
<p>The underwhelming animation above present change in land cover between 2014 and 2017.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="example_s2_land_cover.html" class="btn btn-neutral" title="Sentinel 2 based Land cover example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, CONABIO

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>